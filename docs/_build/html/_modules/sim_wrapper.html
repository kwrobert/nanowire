<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sim_wrapper &#8212; Nanowire .1 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Nanowire .1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sim_wrapper</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="c1">#import subprocess</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#import glob</span>
<span class="c1">#  import datetime</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="c1">#  import hashlib</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="c1">#import pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">optz</span>
<span class="kn">import</span> <span class="nn">postprocess</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1">#import pprint</span>
<span class="kn">import</span> <span class="nn">argparse</span> <span class="k">as</span> <span class="nn">ap</span>
<span class="kn">import</span> <span class="nn">ruamel.yaml</span> <span class="k">as</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># import gc3libs</span>
<span class="c1"># from gc3libs.core import Core, Engine</span>

<span class="c1"># get our custom config object and the logger function</span>
<span class="kn">from</span> <span class="nn">utils.simulator</span> <span class="k">import</span> <span class="n">Simulator</span>
<span class="kn">from</span> <span class="nn">utils.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">utils.utils</span> <span class="k">import</span> <span class="n">configure_logger</span><span class="p">,</span> <span class="n">make_hash</span><span class="p">,</span> <span class="n">get_combos</span>
<span class="c1"># from rcwa_app import RCWA_App</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="c1">#  from functools import wraps</span>
<span class="c1">#  from contextlib import contextmanager</span>
<span class="c1">#  from sqlalchemy.ext.declarative import declarative_base</span>
<span class="c1">#  from sqlalchemy.orm import sessionmaker</span>

<span class="c1">#__DB_ENGINE__ = None</span>
<span class="c1">#__SESSION_FACTORY__ = None</span>
<span class="c1">#Base = declarative_base()</span>
<span class="c1">#</span>
<span class="c1"># def setup_db(name,verbose=False):</span>
<span class="c1">#    &quot;&quot;&quot;Sets up the module-scope database engine and the session factory&quot;&quot;&quot;</span>
<span class="c1">#    global __DB_ENGINE__</span>
<span class="c1">#    global __SESSION_FACTORY__</span>
<span class="c1">#    if not __DB_ENGINE__ and not __SESSION_FACTORY__:</span>
<span class="c1">#        __DB_ENGINE__ = create_engine(&#39;sqlite:///{}&#39;.format(name),echo=verbose)</span>
<span class="c1">#        __SESSION_FACTORY__ = sessionmaker(bind=__DB_ENGINE__)</span>
<span class="c1">#        Base.metadata.create_all(__DB_ENGINE__)</span>
<span class="c1">#        Simulation.metadata.create_all(__DB_ENGINE__)</span>
<span class="c1">#    else:</span>
<span class="c1">#        raise RuntimeError(&#39;DB Engine already set&#39;)</span>
<span class="c1">#</span>
<span class="c1">#@contextmanager</span>
<span class="c1"># def session_scope():</span>
<span class="c1">#    &quot;&quot;&quot;Provide a transactional scope around a series of operations.&quot;&quot;&quot;</span>
<span class="c1">#    session = __SESSION_FACTORY__()</span>
<span class="c1">#    try:</span>
<span class="c1">#        yield session</span>
<span class="c1">#        session.commit()</span>
<span class="c1">#    except:</span>
<span class="c1">#        session.rollback()</span>
<span class="c1">#        raise</span>
<span class="c1">#    finally:</span>
<span class="c1">#        session.close()</span>

<span class="c1"># def dbconnect(func):</span>
<span class="c1">#    @wraps(func)</span>
<span class="c1">#    def wrapper(*args,**kwargs):</span>
<span class="c1">#        session = __SESSION_FACTORY__()</span>
<span class="c1">#        print(&#39;Setting up session scope&#39;)</span>
<span class="c1">#        print(&#39;Here is session in wrapper&#39;)</span>
<span class="c1">#        print(session)</span>
<span class="c1">#        return func(*args,**kwargs)</span>
<span class="c1">#    return wrapper</span>


<div class="viewcode-block" id="parse_file"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.parse_file">[docs]</a><span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Super simple utility to parse a yaml file given a path&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfile</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">cfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span></div>


<div class="viewcode-block" id="make_confs"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.make_confs">[docs]</a><span class="k">def</span> <span class="nf">make_confs</span><span class="p">(</span><span class="n">global_conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make all the configuration dicts for each parameter combination&quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Constructing simulator objects ...&#39;</span><span class="p">)</span>
    <span class="n">locs</span><span class="p">,</span> <span class="n">combos</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">get_combos</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">global_conf</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
    <span class="n">confs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">:</span>
        <span class="c1"># Make a copy of the global config for this parameter combos. This copy</span>
        <span class="c1"># represents an individual simulation</span>
        <span class="n">sim_conf</span> <span class="o">=</span> <span class="n">global_conf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">sim_conf</span><span class="p">[</span><span class="s1">&#39;Postprocessing&#39;</span><span class="p">]</span>
        <span class="c1"># Now we just overwrite all the variable parameters with their new</span>
        <span class="c1"># fixed values. Note that itertools.product is so wonderful and</span>
        <span class="c1"># nice that it preserves the order of the values in every combo</span>
        <span class="c1"># such that the combo values always line up with the proper</span>
        <span class="c1"># parameter name</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combo</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s1">&#39;frequency&#39;</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">sim_conf</span><span class="p">[</span><span class="n">global_conf</span><span class="o">.</span><span class="n">variable</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                                     <span class="s1">&#39;bin_size&#39;</span><span class="p">:</span> <span class="n">bin_size</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sim_conf</span><span class="p">[</span><span class="n">global_conf</span><span class="o">.</span><span class="n">variable</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span>
        <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim_conf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">confs</span></div>


<div class="viewcode-block" id="run_sim"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.run_sim">[docs]</a><span class="k">def</span> <span class="nf">run_sim</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actually runs simulation in a given directory using subprocess.call.</span>
<span class="sd">    Expects a tuple containing the absolute path to the job directory as the</span>
<span class="sd">    first element and the configuration object for the job as the second</span>
<span class="sd">    element</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">variable_thickness</span><span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulator</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">variable_thickness</span><span class="p">:</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">update_id</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">period</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;array_period&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">shell_rad</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Layers&#39;</span><span class="p">][</span><span class="s1">&#39;NW_AlShell&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;shell_radius&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shell_rad</span> <span class="o">&gt;</span> <span class="n">period</span><span class="o">/</span><span class="mf">2.0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sim </span><span class="si">%s</span><span class="s1"> has shell radius larger than half the period,&#39;</span>
                     <span class="s1">&#39; returning&#39;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executing sim </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing a thickness sweep at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">orig_id</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
        <span class="c1"># Get all combinations of layer thicknesses</span>
        <span class="n">keys</span><span class="p">,</span> <span class="n">combos</span><span class="p">,</span> <span class="n">bin_size</span> <span class="o">=</span> <span class="n">get_combos</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">variable_thickness</span><span class="p">)</span>
        <span class="c1"># Update base directory to new sub directory</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dir</span>
        <span class="c1"># Set things up for the first combo</span>
        <span class="n">combo</span> <span class="o">=</span> <span class="n">combos</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c1"># First update all the thicknesses in the config. We make a copy of the</span>
        <span class="c1"># list because it gets continually updated in the config object</span>
        <span class="n">var_thickness</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">variable_thickness</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combo</span><span class="p">)):</span>
            <span class="n">keyseq</span> <span class="o">=</span> <span class="n">var_thickness</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="n">keyseq</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span>
        <span class="c1"># With all the params updated we can now run substutions and</span>
        <span class="c1"># evaluations in the config that make have referred to some thickness</span>
        <span class="c1"># data, then make the subdir from the sim id and get the data</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">update_id</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orig_id</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing initial thickness at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subpath</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="c1"># Now we can repeat the same exact process, but instead of rebuilding</span>
        <span class="c1"># the device we just update the thicknesses</span>
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">combos</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combo</span><span class="p">)):</span>
                <span class="n">keyseq</span> <span class="o">=</span> <span class="n">var_thickness</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="n">keyseq</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">update_id</span><span class="p">()</span>
            <span class="n">subpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orig_id</span><span class="p">,</span> <span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing additional thickness at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subpath</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
            <span class="n">sim</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">runtime</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Simulation </span><span class="si">{}</span><span class="s1"> completed in </span><span class="si">{:.2}</span><span class="s1">&#39;</span>
             <span class="s1">&#39; seconds!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">runtime</span><span class="p">))</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="gc3_submit"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.gc3_submit">[docs]</a><span class="k">def</span> <span class="nf">gc3_submit</span><span class="p">(</span><span class="n">gconf</span><span class="p">,</span> <span class="n">sim_confs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function runs jobs on a bunch of remote hosts via SSH</span>
<span class="sd">    and well as on the local machine using a library called gc3pie. Requires</span>
<span class="sd">    gc3pie to be installed and configured. Currently super slow and not really</span>
<span class="sd">    worth using.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;GC3 FUNCTION&#39;</span><span class="p">)</span>
    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">sim_confs</span><span class="p">:</span>
        <span class="c1"># Set up the config object and make local simulation directory</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
        <span class="n">sim_id</span> <span class="o">=</span> <span class="n">make_hash</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sim_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="n">sim_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;sim_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim_dir</span><span class="p">,</span> <span class="s1">&#39;sim_conf.yml&#39;</span><span class="p">))</span>
        <span class="c1"># Create the GC3 Application object and append to list of apps to run</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">RCWA_App</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
    <span class="c1"># Get the config for all resources, auth, etc.</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">gc3libs</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="o">*</span><span class="n">gc3libs</span><span class="o">.</span><span class="n">Default</span><span class="o">.</span><span class="n">CONFIG_FILE_LOCATIONS</span><span class="p">,</span>
                                       <span class="n">auto_enable_auth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gcore</span> <span class="o">=</span> <span class="n">Core</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">(</span><span class="n">gcore</span><span class="p">,</span> <span class="n">tasks</span><span class="o">=</span><span class="n">jobs</span><span class="p">,</span> <span class="n">retrieve_overwrites</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># eng = Engine(gcore, tasks=jobs)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">eng</span><span class="o">.</span><span class="n">progress</span><span class="p">()</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;TERMINATED&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking jobs&#39;</span><span class="p">)</span>
            <span class="n">eng</span><span class="o">.</span><span class="n">progress</span><span class="p">()</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
            <span class="n">states</span> <span class="o">=</span> <span class="n">eng</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KILLING REMOTE JOBS BEFORE QUITTING&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PLEASE BE PATIENT&#39;</span><span class="p">)</span>
        <span class="c1"># Kill all remote jobs</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">eng</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="c1"># update job states</span>
        <span class="n">eng</span><span class="o">.</span><span class="n">progress</span><span class="p">()</span>
        <span class="c1"># free remote resources</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="n">eng</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
        <span class="c1"># now raise exception</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="execute_jobs"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.execute_jobs">[docs]</a><span class="k">def</span> <span class="nf">execute_jobs</span><span class="p">(</span><span class="n">gconf</span><span class="p">,</span> <span class="n">confs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given a list of configuration dictionaries, run them either serially or in</span>
<span class="sd">    parallel by applying run_sim to each dict. We do this instead of applying</span>
<span class="sd">    to an actual Simulator object because the Simulator objects are not</span>
<span class="sd">    pickeable and thus cannot be parallelized by the multiprocessing lib&quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;execution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executing sims serially&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">confs</span><span class="p">:</span>
            <span class="n">run_sim</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;execution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parallel&#39;</span><span class="p">:</span>
        <span class="c1"># All this crap is necessary for killing the parent and all child</span>
        <span class="c1"># processes with CTRL-C</span>
        <span class="n">num_procs</span> <span class="o">=</span> <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;num_cores&#39;</span><span class="p">]</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executing sims in parallel using </span><span class="si">%s</span><span class="s1"> cores ...&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">num_procs</span><span class="p">))</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_procs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map_async</span><span class="p">(</span><span class="n">run_sim</span><span class="p">,</span> <span class="n">confs</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">999999999</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">gconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;execution&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gc3&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executing jobs using gc3 submission tools&#39;</span><span class="p">)</span>
        <span class="n">gc3_submit</span><span class="p">(</span><span class="n">gconf</span><span class="p">,</span> <span class="n">confs</span><span class="p">)</span></div>


<div class="viewcode-block" id="spectral_wrapper"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.spectral_wrapper">[docs]</a><span class="k">def</span> <span class="nf">spectral_wrapper</span><span class="p">(</span><span class="n">opt_pars</span><span class="p">,</span> <span class="n">baseconf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper function to handle spectral sweeps and postprocessing for the scipy minimizer. It</span>
<span class="sd">    accepts the initial guess as a vector, the base config file, and the keys that map to the</span>
<span class="sd">    initial guesses. It runs a spectral sweep (in parallel if specified), postprocesses the results,</span>
<span class="sd">    and returns the spectrally weighted reflection&quot;&quot;&quot;</span>
    <span class="c1"># TODO: Pass in the quantity we want to optimize as a parameter, then compute and return that</span>
    <span class="c1"># instead of just assuming reflection</span>

    <span class="c1"># Optimizing shell thickness could result is negative thickness so we need to take absolute</span>
    <span class="c1"># value here</span>
    <span class="c1">#opt_pars[0] = abs(opt_pars[0])</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Param keys: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">baseconf</span><span class="o">.</span><span class="n">optimized</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Current values </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt_pars</span><span class="p">))</span>
    <span class="c1"># Clean up old data unless the user asked us not to. We do this first so on the last</span>
    <span class="c1"># iteration all our data is left intact</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">baseconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">baseconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;opt_keep_intermediates&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">basedir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">!=</span> <span class="s1">&#39;logs&#39;</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="c1"># Set the value key of all the params we are optimizing over to the current</span>
    <span class="c1"># guess</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baseconf</span><span class="o">.</span><span class="n">optimized</span><span class="p">)):</span>
        <span class="n">keyseq</span> <span class="o">=</span> <span class="n">baseconf</span><span class="o">.</span><span class="n">optimized</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">keyseq</span><span class="p">)</span>
        <span class="n">valseq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">keyseq</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">valseq</span><span class="p">)</span>
        <span class="n">baseconf</span><span class="p">[</span><span class="n">valseq</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">opt_pars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1"># Make all the sim objects</span>
    <span class="n">sims</span> <span class="o">=</span> <span class="n">make_confs</span><span class="p">(</span><span class="n">baseconf</span><span class="p">)</span>
    <span class="c1"># Let&#39;s reuse the convergence information from the previous iteration if it exists</span>
    <span class="c1"># NOTE: This kind of assumes your initial guess was somewhat decent with regards to the in plane</span>
    <span class="c1"># geometric variables and the optimizer is staying relatively close to that initial guess. If</span>
    <span class="c1"># the optimizer is moving far away from its previous guess at each step, then the fact that a</span>
    <span class="c1"># specific frequency may have been converged previously does not mean it will still be converged</span>
    <span class="c1"># with this new set of variables.</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;conv_info.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">info_file</span><span class="p">):</span>
        <span class="n">conv_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">freq</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">,</span> <span class="n">conv_status</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">conv_status</span> <span class="o">==</span> <span class="s1">&#39;converged&#39;</span><span class="p">:</span>
                    <span class="n">conv_dict</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">conv_status</span> <span class="o">==</span> <span class="s1">&#39;unconverged&#39;</span><span class="p">:</span>
                    <span class="n">conv_dict</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">conv</span><span class="p">,</span> <span class="n">numbasis</span> <span class="o">=</span> <span class="n">conv_dict</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span>
            <span class="c1"># Turn off adaptive convergence and update the number of basis</span>
            <span class="c1"># terms</span>
            <span class="k">if</span> <span class="n">conv</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">%s</span><span class="s1"> converged at </span><span class="si">%s</span><span class="s1"> basis&#39;</span>
                         <span class="s1">&#39; terms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">))</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;adaptive_convergence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span>
                    <span class="s1">&#39;numbasis&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbasis</span><span class="p">)</span>
            <span class="c1"># For sims that haven&#39;t converged, set the number of basis terms to the last</span>
            <span class="c1"># tested value so we&#39;re closer to our goal of convergence</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Frequency </span><span class="si">%s</span><span class="s1"> unconverged at </span><span class="si">%s</span><span class="s1"> basis&#39;</span>
                         <span class="s1">&#39; terms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">numbasis</span><span class="p">))</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span>
                    <span class="s1">&#39;numbasis&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numbasis</span><span class="p">)</span>
    <span class="c1"># With the leaf directories made and the number of basis terms adjusted,</span>
    <span class="c1"># we can now kick off our frequency sweep</span>
    <span class="n">execute_jobs</span><span class="p">(</span><span class="n">baseconf</span><span class="p">,</span> <span class="n">sims</span><span class="p">)</span>

    <span class="c1">#####</span>
    <span class="c1"># TODO: This needs to be generalized. The user could pass in the name of</span>
    <span class="c1"># a postprocessing function in the config file. The function will be called</span>
    <span class="c1"># and used as the quantity for optimization</span>
    <span class="c1">#####</span>

    <span class="c1"># With our frequency sweep done, we now need to postprocess the results.</span>
    <span class="c1"># Configure logger</span>
    <span class="c1"># log = configure_logger(&#39;error&#39;,&#39;postprocess&#39;,</span>
    <span class="c1">#                          os.path.join(baseconf[&#39;General&#39;][&#39;base_dir&#39;],&#39;logs&#39;),</span>
    <span class="c1">#                          &#39;postprocess.log&#39;)</span>
    <span class="c1"># Compute transmission data for each individual sim</span>
    <span class="n">cruncher</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Cruncher</span><span class="p">(</span><span class="n">baseconf</span><span class="p">)</span>
    <span class="n">cruncher</span><span class="o">.</span><span class="n">collect_sims</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">sims</span><span class="p">:</span>
        <span class="n">cruncher</span><span class="o">.</span><span class="n">transmissionData</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="c1"># Now get the fraction of photons absorbed</span>
    <span class="n">gcruncher</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Global_Cruncher</span><span class="p">(</span>
        <span class="n">baseconf</span><span class="p">,</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">sims</span><span class="p">,</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">sim_groups</span><span class="p">,</span> <span class="n">cruncher</span><span class="o">.</span><span class="n">failed_sims</span><span class="p">)</span>
    <span class="n">gcruncher</span><span class="o">.</span><span class="n">group_against</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">baseconf</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
    <span class="n">photon_fraction</span> <span class="o">=</span> <span class="n">gcruncher</span><span class="o">.</span><span class="n">fractional_absorbtion</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Lets store information we discovered from our adaptive convergence procedure so we can resue</span>
    <span class="c1"># it in the next iteration.</span>
    <span class="k">if</span> <span class="n">baseconf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;adaptive_convergence&#39;</span><span class="p">]:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Storing adaptive convergence results ...&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">info_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">conv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;converged_at.txt&#39;</span><span class="p">)</span>
                <span class="n">nconv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="s1">&#39;not_converged_at.txt&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">conv_path</span><span class="p">):</span>
                    <span class="n">conv_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">conv_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">numbasis</span> <span class="o">=</span> <span class="n">conv_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">conv_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="s1">&#39;converged&#39;</span>
                <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nconv_path</span><span class="p">):</span>
                    <span class="n">conv_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">nconv_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">numbasis</span> <span class="o">=</span> <span class="n">conv_f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">conv_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="s1">&#39;unconverged&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we were converged on a previous iteration, adaptive</span>
                    <span class="c1"># convergence was switched off and there will be no file to</span>
                    <span class="c1"># read from</span>
                    <span class="n">conv</span> <span class="o">=</span> <span class="s1">&#39;converged&#39;</span>
                    <span class="n">numbasis</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;Simulation&#39;</span><span class="p">][</span>
                        <span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;numbasis&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">info</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="p">),</span> <span class="n">numbasis</span><span class="p">,</span> <span class="n">conv</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Finished storing convergence results!&#39;</span><span class="p">)</span>
    <span class="c1">#print(&#39;Total time = %f&#39;%delta)</span>
    <span class="c1">#print(&#39;Num calls after = %i&#39;%gcruncher.weighted_transmissionData.called)</span>
    <span class="c1"># This is a minimizer, we want to maximize the fraction of photons absorbed and thus minimize</span>
    <span class="c1"># 1 minus that fraction</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">photon_fraction</span></div>


<div class="viewcode-block" id="run_optimization"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.run_optimization">[docs]</a><span class="k">def</span> <span class="nf">run_optimization</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs an optimization on a given set of parameters&quot;&quot;&quot;</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running optimization&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">)</span>
    <span class="c1"># Make sure the only variable parameter we have is a sweep through</span>
    <span class="c1"># frequency</span>
    <span class="k">for</span> <span class="n">keyseq</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">variable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyseq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;frequency&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;You should only be sweep through frequency during an &#39;</span>
                      <span class="s1">&#39;optimization&#39;</span><span class="p">)</span>
            <span class="n">quit</span><span class="p">()</span>
    <span class="c1"># Collect all the guesses</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">)):</span>
        <span class="n">keyseq</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">par_data</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyseq</span><span class="p">)</span>
        <span class="n">guess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_data</span><span class="p">[</span><span class="s1">&#39;guess&#39;</span><span class="p">]</span>
    <span class="c1"># Max iterations and tolerance</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;opt_tol&#39;</span><span class="p">]</span>
    <span class="n">ftol</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;func_opt_tol&#39;</span><span class="p">]</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;opt_max_iter&#39;</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;opt_dir&#39;</span><span class="p">))</span>
    <span class="c1"># Run the simplex optimizer</span>
    <span class="n">opt_val</span> <span class="o">=</span> <span class="n">optz</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">spectral_wrapper</span><span class="p">,</span>
                            <span class="n">guess</span><span class="p">,</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conf</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">max_iter</span><span class="p">,</span> <span class="s1">&#39;xatol&#39;</span><span class="p">:</span> <span class="n">tol</span><span class="p">,</span>
                                     <span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="n">ftol</span><span class="p">,</span> <span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">opt_val</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Optimal values&#39;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">opt_val</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Write out the results to a file</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;optimization_results.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Param name, value</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">,</span> <span class="n">opt_val</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">opt_val</span><span class="o">.</span><span class="n">x</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main run methods that decides what kind of simulation to run based on the</span>
<span class="sd">    provided config object&quot;&quot;&quot;</span>

    <span class="n">basedir</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span>
    <span class="n">lfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;logs/sim_wrapper.log&#39;</span><span class="p">)</span>
    <span class="c1"># Configure logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">configure_logger</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="n">lfile</span><span class="p">)</span>
    <span class="c1"># Just a simple single simulation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">:</span>
        <span class="c1"># Get all the sims</span>
        <span class="n">sims</span> <span class="o">=</span> <span class="n">make_confs</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing job campaign&quot;</span><span class="p">)</span>
        <span class="n">execute_jobs</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sims</span><span class="p">)</span>
    <span class="c1"># If we have variable params, do a parameter sweep</span>
    <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">optimized</span><span class="p">:</span>
        <span class="n">run_optimization</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unsupported configuration for a simulation run. Not a &#39;</span>
                     <span class="s1">&#39;single sim, sweep, or optimization. Make sure your sweeps are &#39;</span>
                     <span class="s1">&#39;configured correctly, and if you are running an optimization &#39;</span>
                     <span class="s1">&#39;make sure you do not have any sorting parameters specified&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pre_check"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.pre_check">[docs]</a><span class="k">def</span> <span class="nf">pre_check</span><span class="p">(</span><span class="n">conf_path</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks conf file for invalid values&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;sim_script&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You need to change the sim_script entry in the [General] section of your config </span><span class="se">\</span>
<span class="s1">        file&#39;</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>

    <span class="c1"># Warn user if they are about to dump a bunch of simulation data and directories into a</span>
    <span class="c1"># directory that already exists</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s2">&quot;General&quot;</span><span class="p">][</span><span class="s2">&quot;base_dir&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!!! You are about to start a simulation in a directory that already exists&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!!! This will dump a whole bunch of crap into that directory and possibly&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!!! overwrite old simulation data.&#39;</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Would you like to continue? CTRL-C to exit, any other key to continue: &#39;</span><span class="p">)</span>
    <span class="c1"># Copy provided config file to basedir</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">conf_path</span><span class="p">)</span>
    <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">conf_path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">shutil</span><span class="o">.</span><span class="n">SameFileError</span><span class="p">:</span>
        <span class="k">pass</span></div>
    <span class="c1"># TODO: Add checks between specified x,y,z samples and plane vals in</span>
    <span class="c1"># plotting section</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../sim_wrapper.html#sim_wrapper.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">ap</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A wrapper around s4_sim.py to automate parameter</span>
<span class="s2">            sweeps, optimization, directory organization, postproccessing, etc.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;config_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Absolute path to the INI file</span>
<span class="s2">    specifying how you want this wrapper to behave&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--log_level&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;critical&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Logging level for the run&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_file</span><span class="p">):</span>
        <span class="n">global_conf</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">config_file</span><span class="p">))</span>
        <span class="c1"># Expand all the environment variables in the global config but</span>
        <span class="c1"># otherwise don&#39;t modify anything</span>
        <span class="n">global_conf</span><span class="o">.</span><span class="n">expand_vars</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The file you specified does not exist! </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">()</span>

    <span class="c1"># setup_db(sim[&#39;General&#39;][&#39;db_name&#39;])</span>
    <span class="c1"># pre_check(os.path.abspath(args.config_file),conf)</span>
    <span class="n">run</span><span class="p">(</span><span class="n">global_conf</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span></div>

<span class="c1"># def db_test():</span>
<span class="c1">#    with session_scope() as session:</span>
<span class="c1">#        print(session)</span>
<span class="c1">#</span>
<span class="c1"># def main():</span>
<span class="c1">#    setup_db(&#39;new_test.db&#39;)</span>
<span class="c1">#    db_test()</span>
<span class="c1">#    #Session = sessionmaker(bind=engine)</span>
<span class="c1">#    #session = Session()</span>
<span class="c1">#    #conf = {&#39;some_stuff&#39;:&#39;wtih a value&#39;}</span>
<span class="c1">#    #sim = Simulation(conf)</span>
<span class="c1">#    #print(sim.__table__)</span>
<span class="c1">#    #print(sim.id)</span>
<span class="c1">#    #session.add(sim)</span>
<span class="c1">#    #session.commit()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Kyle Robertson.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>